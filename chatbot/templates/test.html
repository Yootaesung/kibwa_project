<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ - ê°ì • ì¸ì‹ ì±—ë´‡</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            width: 80%;
            max-width: 1000px;
            min-width: 900px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            background: #f5f7fa;
        }
        
        .chat-header {
            background: #4a6cfa;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .home-btn {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 1.2em;
        }
        
        .home-btn:hover {
            opacity: 0.8;
        }
        
        .test-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            gap: 20px;
            margin: 20px auto 0;
            min-height: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
            max-width: 1000px;
            box-sizing: border-box;
        }
        
        .chat-box {
            flex: 1;
            min-width: 0; /* flex ì•„ì´í…œì´ ì»¨í…Œì´ë„ˆë¥¼ ë„˜ì¹˜ì§€ ì•Šë„ë¡ */
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
            scroll-behavior: smooth; /* ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin: 0;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0.6; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #4a6cfa;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            background: #f0f2f5;
            color: #050505;
            align-self: flex-start;
            border-top-left-radius: 4px;
        }
        
        .emotion-panel {
            flex: 0 0 220px; /* ë„ˆë¹„ 220pxë¡œ ì¡°ì • */
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .current-emotion {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .file-selector {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 30px 40px;
            margin-bottom: 20px;
            flex-shrink: 0;
            width: 100%;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }
        
        select, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        
        .btn {
            background: #4a6cfa;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #3a5ce0;
        }
        
        .btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: #ff4d4f;
        }
        
        .btn-danger:hover {
            background: #ff7875;
        }
        
        .status {
            color: #666;
            font-size: 0.9em;
            text-align: center;
            margin: 10px 0;
            flex-shrink: 0; /* í¬ê¸° ê³ ì • */
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .file-selector {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-content {
            display: none;
            margin-top: 20px;
        }
        
        .content-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chat-container {
            flex: 2;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            max-height: 70vh; /* ë·°í¬íŠ¸ ë†’ì´ì˜ 70%ë¡œ ì œí•œ */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            margin: 0;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
            position: relative;
        }
        
        .user-message {
            background: #4a6cfa;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            background: white;
            color: #333;
            margin-right: auto;
            border-top-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        
        .chat-controls {
            padding: 15px;
            border-top: 1px solid #eee;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .emotion-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
        }
        
        .progress-bar {
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .emotion-item {
            margin-bottom: 15px;
        }
        
        .emotion-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .emotion-display {
            margin-top: 10px;
            padding: 10px;
            background: #f0f2f5;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .emotion-counters {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            width: 100%;
        }
        
        .emotion-counter {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            box-sizing: border-box;
        }
        
        .emotion-counter span {
            font-weight: bold;
            margin-left: 5px;
            color: #4a6cfa;
        }
        
        .current-emotion {
            text-align: center;
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #4a6cfa;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3a5ce0;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff7875;
        }
        
        .btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        
        .status {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-content">
                <h1>ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸</h1>
                <a href="/" class="home-btn" title="í™ˆìœ¼ë¡œ">
                    <span class="material-icons">home</span>
                </a>
            </div>
        </div>
        
        <div class="test-container">
            <div class="file-selector">
                <h2>í…ŒìŠ¤íŠ¸í•  ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</h2>
                <select id="scenario-select">
                    <option value="">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
                    <!-- ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                </select>
                <div style="margin-top: 15px;">
                    <button id="test-control" class="btn" disabled>í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
                </div>
            </div>

        <div class="test-content">
            <div class="content-wrapper">
                <div class="chat-box">
                    <div class="chat-messages" id="chat-box">
                        <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div class="emotion-panel">
                    <h3>í˜„ì¬ ê°ì •</h3>
                    <div class="emotion-display">
                        <div>í˜„ì¬ ê°ì •: <span id="current-emotion">ê°ì • ë¶„ì„ ì¤‘...</span></div>
                        <div class="emotion-counters" id="emotion-counters">
                            <div class="emotion-counter">ğŸ˜Š ê¸°ì¨: <span id="joy-counter">0</span></div>
                            <div class="emotion-counter">ğŸ˜  ë¶„ë…¸: <span id="anger-counter">0</span></div>
                            <div class="emotion-counter">ğŸ˜¢ ìŠ¬í””: <span id="sadness-counter">0</span></div>
                            <div class="emotion-counter">ğŸ˜¨ ë‘ë ¤ì›€: <span id="fear-counter">0</span></div>
                            <div class="emotion-counter">ğŸ˜² ë†€ëŒ: <span id="surprise-counter">0</span></div>
                            <div class="emotion-counter">ğŸ¤¢ í˜ì˜¤: <span id="disgust-counter">0</span></div>
                        </div>
                    </div>
                    <div class="status" id="status">í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
                    
                    <!--
                    <h3>ê°ì • ë¶„ì„ ê²°ê³¼ (ë³´ê´€ìš©)</h3>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>ë¶„ë…¸</span>
                        </div>
                        <div class="progress-bar">
                            <div id="anger-bar" class="progress-fill" style="background-color: #ff4d4f;"></div>
                        </div>
                    </div>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>ê¸°ì¨</span>
                        </div>
                        <div class="progress-bar">
                            <div id="joy-bar" class="progress-fill" style="background-color: #52c41a;"></div>
                        </div>
                    </div>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>ìŠ¬í””</span>
                        </div>
                        <div class="progress-bar">
                            <div id="sadness-bar" class="progress-fill" style="background-color: #1890ff;"></div>
                        </div>
                    </div>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>ë‘ë ¤ì›€</span>
                        </div>
                        <div class="progress-bar">
                            <div id="fear-bar" class="progress-fill" style="background-color: #722ed1;"></div>
                        </div>
                    </div>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>ë†€ëŒ</span>
                        </div>
                        <div class="progress-bar">
                            <div id="surprise-bar" class="progress-fill" style="background-color: #faad14;"></div>
                        </div>
                    </div>
                    <div class="current-emotion" id="current-emotion">
                        í˜„ì¬ ê°ì •: -
                    </div>
                    -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const scenarioSelect = document.getElementById('scenario-select');
            const startBtn = document.getElementById('start-test');
            const chatBox = document.getElementById('chat-box');
            const statusDiv = document.getElementById('status');
            const testContent = document.querySelector('.test-content');
            
            // í…ŒìŠ¤íŠ¸ ìƒíƒœ ë³€ìˆ˜
            let currentScenario = null;
            let currentMessageIndex = 0;
            let emotionScores = {
                'ê¸°ì¨': 0,
                'ìŠ¬í””': 0,
                'ë¶„ë…¸': 0,
                'ë‘ë ¤ì›€': 0,
                'ë†€ëŒ': 0
            };
            let testInterval = null;
            let isTestRunning = false;
            
            // ê°ì •ë³„ ìƒ‰ìƒ ë° ì´ëª¨í‹°ì½˜
            const emotionColors = {
                'ê¸°ì¨': '#FFD700',
                'ìŠ¬í””': '#5D8AA8',
                'ë¶„ë…¸': '#FF4B4B',
                'ë¶ˆì•ˆ': '#FFA500',
                'ì¤‘ë¦½': '#808080',
                'ë†€ë¼ì›€': '#9B59B6',
                'í˜ì˜¤': '#8E44AD',
                'ê¸°ëŒ€': '#3498DB',
                'ê°ì‚¬': '#2ECC71',
                'ì§€ë£¨í•¨': '#95A5A6',
                'í”¼ë¡œ': '#7F8C8D',
                'ë‘ë ¤ì›€': '#722ed1',
                'ë†€ëŒ': '#9B59B6'
            };
            
            const emotionIcons = {
                'ê¸°ì¨': 'ğŸ˜Š',
                'ìŠ¬í””': 'ğŸ˜¢',
                'ë¶„ë…¸': 'ğŸ˜ ',
                'ë¶ˆì•ˆ': 'ğŸ˜¨',
                'ì¤‘ë¦½': 'ğŸ˜',
                'ë†€ë¼ì›€': 'ğŸ˜²',
                'í˜ì˜¤': 'ğŸ¤¢',
                'ê¸°ëŒ€': 'ğŸ¤©',
                'ê°ì‚¬': 'ğŸ™',
                'ì§€ë£¨í•¨': 'ğŸ˜‘',
                'í”¼ë¡œ': 'ğŸ˜´',
                'ë‘ë ¤ì›€': 'ğŸ˜¨',
                'ë†€ëŒ': 'ğŸ˜²'
            };
            
            // ê°ì • ì¹´ìš´í„° ì´ˆê¸°í™” í•¨ìˆ˜
            function resetEmotionCounters() {
                const counters = document.querySelectorAll('.emotion-counter span');
                counters.forEach(counter => {
                    counter.textContent = '0';
                });
            }

            // ê°ì • ì¹´ìš´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateEmotionCounters(emotion) {
                if (!emotion) return;
                
                // ê°ì •ì— ë”°ë¼ ì¹´ìš´í„° ID ë§¤í•‘
                const counterMap = {
                    'ê¸°ì¨': 'joy-counter',
                    'ë¶„ë…¸': 'anger-counter',
                    'ìŠ¬í””': 'sadness-counter',
                    'ë‘ë ¤ì›€': 'fear-counter',
                    'ë†€ëŒ': 'surprise-counter',
                    'í˜ì˜¤': 'disgust-counter'
                };
                
                const counterId = counterMap[emotion];
                if (counterId) {
                    const counter = document.getElementById(counterId);
                    if (counter) {
                        counter.textContent = parseInt(counter.textContent) + 1;
                    }
                }
            }

            // ê°ì • í‘œì‹œ í•¨ìˆ˜ - í˜„ì¬ ê°ì •ë§Œ í‘œì‹œ
            function updateEmotionScores(emotion) {
                const emotionElement = document.getElementById('current-emotion');
                
                // ê°ì •ì´ ì—†ê±°ë‚˜ ì •ì˜ë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
                if (!emotion || !emotionColors[emotion]) {
                    emotion = 'ì¤‘ë¦½';
                }
                
                // ê°ì • í‘œì‹œ ì—…ë°ì´íŠ¸
                emotionElement.textContent = `${emotionIcons[emotion] || 'ğŸ˜'} ${emotion}`;
                emotionElement.style.backgroundColor = `${emotionColors[emotion] || '#808080'}20`; // 20% íˆ¬ëª…ë„
                emotionElement.style.color = emotionColors[emotion] || '#808080';
                
                // ê°ì •ì´ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ ì¹´ìš´í„° ì¦ê°€
                updateEmotionCounters(emotion);
            }

            // ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            async function loadScenarios() {
                try {
                    const response = await fetch('/api/test/scenarios');
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.detail || 'ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ë¡œë”© ì¤‘ ë©”ì‹œì§€ ì œì™¸)
                    while (scenarioSelect.options.length > 1) {
                        scenarioSelect.remove(1);
                    }
                    
                    // ì‹œë‚˜ë¦¬ì˜¤ ì˜µì…˜ ì¶”ê°€
                    data.scenarios.forEach(scenario => {
                        const option = document.createElement('option');
                        option.value = scenario.key;
                        option.textContent = `${scenario.age_group} / ${scenario.gender} / ${scenario.role}`;
                        scenarioSelect.appendChild(option);
                    });
                    
                    // ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                    scenarioSelect.addEventListener('change', () => {
                        testControlBtn.disabled = !scenarioSelect.value;
                    });
                    
                } catch (error) {
                    console.error('ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    alert('ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
            function addMessage(role, content) {
                if (!content) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;
                messageDiv.textContent = content;
                
                // ë©”ì‹œì§€ ì¶”ê°€ ì „ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
                const shouldScroll = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 50;
                
                chatBox.appendChild(messageDiv);
                
                // ìŠ¤í¬ë¡¤ì´ ë§¨ ì•„ë˜ì— ê°€ê¹Œì› ë‹¤ë©´ ìë™ ìŠ¤í¬ë¡¤
                if (shouldScroll) {
                    // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ìŠ¤í¬ë¡¤ì´ ìì—°ìŠ¤ëŸ½ê²Œ ë™ì‘í•˜ë„ë¡ í•¨
                    setTimeout(() => {
                        chatBox.scrollTo({
                            top: chatBox.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 50);
                }
                
                // ë©”ì‹œì§€ ê¸°ë¡ì— ì¶”ê°€ (í•„ìš”í•œ ê²½ìš°)
                // currentMessages.push({ role, content });
            }

            // ì±—ë´‡ ì‘ë‹µ ìƒì„±
            async function generateBotResponse(userMessage) {
                try {
                    // í˜„ì¬ ë©”ì‹œì§€ì˜ ê°ì • ê°€ì ¸ì˜¤ê¸°
                    const currentMessage = currentScenario.messages[currentMessageIndex];
                    const currentEmotion = currentMessage.emotion || 'ê¸°ì¨';  // ê¸°ë³¸ê°’ì€ 'ê¸°ì¨'
                    
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            is_test: true,
                            action: 'message',
                            is_filtered: false,
                            emotion: currentEmotion  // í˜„ì¬ ê°ì • ì¶”ê°€
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('ì±—ë´‡ ì‘ë‹µ ì˜¤ë¥˜:', response.status, errorData);
                        throw new Error(`ì±—ë´‡ ì‘ë‹µ ìƒì„± ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return data.response || 'ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ë§ì”€í•´ ì£¼ì„¸ìš”.';
                } catch (error) {
                    console.error('ì±—ë´‡ ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                    return 'ì£„ì†¡í•©ë‹ˆë‹¤. ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }
            }

            // ë‹¤ìŒ ë©”ì‹œì§€ ë³´ë‚´ê¸°
            async function sendNextMessage() {
                if (!isTestRunning || !currentScenario || !currentScenario.messages || 
                    currentMessageIndex >= currentScenario.messages.length) {
                    console.log('í…ŒìŠ¤íŠ¸ ì¢…ë£Œ. isTestRunning:', isTestRunning, 
                                'has currentScenario:', !!currentScenario,
                                'messages length:', currentScenario?.messages?.length);
                    await endTest();
                    return;
                }

                try {
                    // ì‚¬ìš©ì ë©”ì‹œì§€ ë³´ë‚´ê¸°
                    const userMessage = currentScenario.messages[currentMessageIndex];
                    addMessage('user', userMessage.content);
                    
                    // ê°ì •ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                    if (userMessage.emotion) {
                        updateEmotionScores(userMessage.emotion);
                    }
                    
                    // ì±—ë´‡ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ê¸° ì „ì— ì ì‹œ ëŒ€ê¸° (ëŒ€ê¸° ì‹œê°„ ë‹¨ì¶•)
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // ì±—ë´‡ ì‘ë‹µ ìƒì„± ë° í‘œì‹œ
                    const botResponse = await generateBotResponse(userMessage.content);
                    addMessage('bot', botResponse);
                    
                    // ë‹¤ìŒ ë©”ì‹œì§€ë¡œ ì´ë™ (ì§€ì—° ì‹œê°„ ë‹¨ì¶•)
                    currentMessageIndex++;
                    if (isTestRunning && currentMessageIndex < currentScenario.messages.length) {
                        // ë‹¤ìŒ ë©”ì‹œì§€ ì „ì†¡ ì „ì— ì ì‹œ ëŒ€ê¸° (ëŒ€ê¸° ì‹œê°„ ë‹¨ì¶•)
                        setTimeout(sendNextMessage, 300);
                    } else {
                        await endTest();
                    }
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:', error);
                    addMessage('bot', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    await endTest();
                }
            }

            // í…ŒìŠ¤íŠ¸ ì‹œì‘
            async function startTest() {
                const scenarioId = scenarioSelect.value;
                if (!scenarioId) {
                    alert('ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    // í…ŒìŠ¤íŠ¸ ì‹œì‘ ìƒíƒœë¡œ ë³€ê²½
                    isTestRunning = true;
                    testControlBtn.textContent = 'í…ŒìŠ¤íŠ¸ ì¢…ë£Œ';
                    testControlBtn.classList.add('btn-danger');
                    scenarioSelect.disabled = true;
                    
                    // ê°ì • ì¹´ìš´í„° ì´ˆê¸°í™”
                    resetEmotionCounters();
                    
                    // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const response = await fetch(`/api/test/scenario/${encodeURIComponent(scenarioId)}`);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.detail || 'ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    // ìƒíƒœ ì´ˆê¸°í™”
                    currentScenario = data.scenario;
                    currentMessageIndex = 0;
                    chatBox.innerHTML = '';
                    statusDiv.textContent = 'í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘...';
                    
                    console.log('Loaded scenario:', currentScenario);  // ë””ë²„ê¹…ìš© ë¡œê·¸
                    testContent.style.display = 'block';
                    
                    // í˜„ì¬ ê°ì • ì´ˆê¸°í™”
                    const emotionElement = document.getElementById('current-emotion');
                    emotionElement.textContent = '-';
                    emotionElement.style.color = '#4a6cfa'; // ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ì´ˆê¸°í™”
                    
                    // ì²« ë²ˆì§¸ ë©”ì‹œì§€ ì „ì†¡
                    sendNextMessage();
                    
                } catch (error) {
                    console.error('í…ŒìŠ¤íŠ¸ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    alert('í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    statusDiv.textContent = 'ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
                    isTestRunning = false;
                }
            }

            // í…ŒìŠ¤íŠ¸ ì¢…ë£Œ
            async function endTest() {
                // í…ŒìŠ¤íŠ¸ ì¤‘ì§€
                if (testInterval) {
                    clearInterval(testInterval);
                    testInterval = null;
                }
                
                // í…ŒìŠ¤íŠ¸ ì¢…ë£Œ ìƒíƒœë¡œ ë³€ê²½
                isTestRunning = false;
                testControlBtn.textContent = 'í…ŒìŠ¤íŠ¸ ì‹œì‘';
                testControlBtn.classList.remove('btn-danger');
                scenarioSelect.disabled = false;
                
                // í˜„ì¬ ë©”ì‹œì§€ ì¸ë±ìŠ¤ë§Œ ì´ˆê¸°í™” (ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒì€ ìœ ì§€)
                currentMessageIndex = 0;
                
                // ì±„íŒ… ë‚´ìš©ì€ ìœ ì§€ (ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ)
                
                // ë§ˆì§€ë§‰ ê°ì • ìœ ì§€ (ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ)
                
                statusDiv.textContent = 'í…ŒìŠ¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ [í…ŒìŠ¤íŠ¸ ì‹œì‘] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.';
                
                // ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒì´ ë³€ê²½ë˜ë©´ ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
                const resetStatus = () => {
                    statusDiv.textContent = 'í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë ¤ë©´ [í…ŒìŠ¤íŠ¸ ì‹œì‘] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.';
                    scenarioSelect.removeEventListener('change', resetStatus);
                };
                scenarioSelect.addEventListener('change', resetStatus);
                
                try {
                    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì €ì¥ (í•„ìš”í•œ ê²½ìš°)
                    // await fetch('/api/test/save', {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify({
                    //         scenarioId: currentScenario?.id,
                    //         messages: currentMessages,
                    //         emotionScores
                    //     })
                    // });
                } catch (error) {
                    console.error('í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                }
            }

            // í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ (ì‹œì‘/ì¢…ë£Œ í† ê¸€)
            const testControlBtn = document.getElementById('test-control');
            
            testControlBtn.addEventListener('click', function() {
                if (isTestRunning) {
                    endTest();
                } else {
                    startTest();
                }
            });

            // ì´ˆê¸°í™”
            loadScenarios();
        });
    </script>
</body>
</html>
