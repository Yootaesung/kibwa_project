<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테스트 - 감정 인식 챗봇</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .file-selector {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-content {
            display: none;
            margin-top: 20px;
        }
        
        .content-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chat-container {
            flex: 2;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            min-height: 500px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
            position: relative;
        }
        
        .user-message {
            background: #4a6cfa;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            background: white;
            color: #333;
            margin-right: auto;
            border-top-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        
        .chat-controls {
            padding: 15px;
            border-top: 1px solid #eee;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .emotion-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
        }
        
        .progress-bar {
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .emotion-item {
            margin-bottom: 15px;
        }
        
        .emotion-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .current-emotion {
            text-align: center;
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #4a6cfa;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3a5ce0;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff7875;
        }
        
        .btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        
        .status {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="file-selector">
            <h1>챗봇 테스트</h1>
            <h2>테스트할 시나리오 선택</h2>
            <select id="scenario-select">
                <option value="">시나리오를 선택하세요...</option>
                <!-- 시나리오 목록이 여기에 동적으로 로드됩니다 -->
            </select>
            <div style="margin-top: 15px;">
                <button id="start-test" class="btn btn-primary" disabled>테스트 시작</button>
            </div>
        </div>

        <div class="test-content">
            <div class="content-wrapper">
                <div class="chat-container">
                    <div class="chat-box" id="chat-box">
                        <!-- 채팅 메시지가 여기에 표시됩니다 -->
                    </div>
                    <div class="chat-controls">
                        <button id="end-test" class="btn btn-danger">테스트 종료</button>
                        <div class="status" id="status">테스트가 진행 중이 아닙니다.</div>
                    </div>
                </div>

                <div class="emotion-panel">
                    <h3>감정 상태</h3>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>분노</span>
                            <span id="emotion-anger">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="anger-bar" style="background-color: #ff4d4f;"></div>
                        </div>
                    </div>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>기쁨</span>
                            <span id="emotion-joy">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="joy-bar" style="background-color: #52c41a;"></div>
                        </div>
                    </div>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>슬픔</span>
                            <span id="emotion-sadness">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="sadness-bar" style="background-color: #1890ff;"></div>
                        </div>
                    </div>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>두려움</span>
                            <span id="emotion-fear">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="fear-bar" style="background-color: #722ed1;"></div>
                        </div>
                    </div>
                    <div class="emotion-item">
                        <div class="emotion-header">
                            <span>놀람</span>
                            <span id="emotion-surprise">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="surprise-bar" style="background-color: #faad14;"></div>
                        </div>
                    </div>
                    <div class="current-emotion" id="current-emotion">
                        현재 감정: -
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM 요소 가져오기
            const scenarioSelect = document.getElementById('scenario-select');
            const startBtn = document.getElementById('start-test');
            const endBtn = document.getElementById('end-test');
            const chatBox = document.getElementById('chat-box');
            const statusDiv = document.getElementById('status');
            const testContent = document.querySelector('.test-content');
            
            // 상태 변수
            let currentScenario = null;
            let messageIndex = 0;
            let isTestRunning = false;
            let emotionScores = {
                '분노': 0,
                '기쁨': 0,
                '슬픔': 0,
                '두려움': 0,
                '놀람': 0
            };

            // 감정 점수 업데이트 함수
            function updateEmotionScores(emotion) {
                if (!emotionScores.hasOwnProperty(emotion)) return;
                
                // 현재 감정 점수 증가
                emotionScores[emotion] += 1;
                
                // 총합 계산
                const total = Object.values(emotionScores).reduce((sum, score) => sum + score, 0);
                
                // 각 감정의 퍼센테이지 계산 및 업데이트
                for (const [key, value] of Object.entries(emotionScores)) {
                    const percentage = Math.round((value / total) * 100);
                    const emotionId = key === '분노' ? 'anger' : 
                                     key === '기쁨' ? 'joy' :
                                     key === '슬픔' ? 'sadness' :
                                     key === '두려움' ? 'fear' : 'surprise';
                    
                    document.getElementById(`emotion-${emotionId}`).textContent = `${percentage}%`;
                    document.getElementById(`${emotionId}-bar`).style.width = `${percentage}%`;
                }
                
                // 현재 가장 높은 감정 찾기
                const maxEmotion = Object.entries(emotionScores).reduce((a, b) => a[1] > b[1] ? a : b)[0];
                document.getElementById('current-emotion').textContent = `현재 감정: ${maxEmotion}`;
            }

            // 시나리오 목록 불러오기
            async function loadScenarios() {
                try {
                    const response = await fetch('/api/test/scenarios');
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.detail || '시나리오를 불러오는 데 실패했습니다.');
                    }
                    
                    // 기존 옵션 제거 (로딩 중 메시지 제외)
                    while (scenarioSelect.options.length > 1) {
                        scenarioSelect.remove(1);
                    }
                    
                    // 시나리오 옵션 추가
                    data.scenarios.forEach(scenario => {
                        const option = document.createElement('option');
                        option.value = scenario.key;
                        option.textContent = `${scenario.age_group} / ${scenario.gender} / ${scenario.role}`;
                        scenarioSelect.appendChild(option);
                    });
                    
                    // 시나리오 선택 이벤트 리스너
                    scenarioSelect.addEventListener('change', () => {
                        startBtn.disabled = !scenarioSelect.value;
                    });
                    
                } catch (error) {
                    console.error('시나리오를 불러오는 중 오류 발생:', error);
                    alert('시나리오를 불러오는 중 오류가 발생했습니다: ' + error.message);
                }
            }

            // 채팅 메시지 추가 함수
            function addMessage(role, content) {
                if (!content) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;
                messageDiv.textContent = content;
                
                // 메시지 추가 전 스크롤 위치 저장
                const shouldScroll = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 50;
                
                chatBox.appendChild(messageDiv);
                
                // 스크롤이 맨 아래에 가까웠다면 자동 스크롤
                if (shouldScroll) {
                    // 약간의 지연을 두어 스크롤이 자연스럽게 동작하도록 함
                    setTimeout(() => {
                        chatBox.scrollTo({
                            top: chatBox.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 50);
                }
                
                // 메시지 기록에 추가 (필요한 경우)
                // currentMessages.push({ role, content });
            }

            // 챗봇 응답 생성
            async function generateBotResponse(userMessage) {
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            is_test: true,
                            action: 'message',
                            is_filtered: false
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('챗봇 응답 오류:', response.status, errorData);
                        throw new Error(`챗봇 응답 생성 실패: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return data.response || '이해하지 못했어요. 다시 말씀해 주세요.';
                } catch (error) {
                    console.error('챗봇 응답 생성 중 오류:', error);
                    return '죄송합니다. 잠시 후에 다시 시도해주세요.';
                }
            }

            // 다음 메시지 보내기
            async function sendNextMessage() {
                if (!isTestRunning || !currentScenario || !currentScenario.messages || 
                    messageIndex >= currentScenario.messages.length) {
                    console.log('테스트 종료. isTestRunning:', isTestRunning, 
                                'has currentScenario:', !!currentScenario,
                                'messages length:', currentScenario?.messages?.length);
                    await endTest();
                    return;
                }

                try {
                    // 사용자 메시지 보내기
                    const userMessage = currentScenario.messages[messageIndex];
                    addMessage('user', userMessage.content);
                    
                    // 감정이 있으면 업데이트
                    if (userMessage.emotion) {
                        updateEmotionScores(userMessage.emotion);
                    }
                    
                    // 챗봇 응답을 기다리기 전에 잠시 대기 (사용자가 메시지를 읽을 시간을 줌)
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // 챗봇 응답 생성 및 표시
                    const botResponse = await generateBotResponse(userMessage.content);
                    addMessage('bot', botResponse);
                    
                    // 다음 메시지로 이동 (지연 시간 추가)
                    messageIndex++;
                    if (isTestRunning && messageIndex < currentScenario.messages.length) {
                        // 다음 메시지 전송 전에 잠시 대기
                        setTimeout(sendNextMessage, 1000);
                    } else {
                        await endTest();
                    }
                } catch (error) {
                    console.error('메시지 전송 중 오류:', error);
                    addMessage('bot', '죄송합니다. 오류가 발생했습니다.');
                    await endTest();
                }
            }

            // 테스트 시작
            async function startTest() {
                const scenarioKey = scenarioSelect.value;
                if (!scenarioKey) return;

                try {
                    // 시나리오 데이터 가져오기
                    const response = await fetch(`/api/test/scenario/${encodeURIComponent(scenarioKey)}`);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.detail || '시나리오를 불러오는 데 실패했습니다.');
                    }
                    
                    // 상태 초기화
                    currentScenario = data.scenario;  // data.scenario로 수정
                    messageIndex = 0;
                    
                    console.log('Loaded scenario:', currentScenario);  // 디버깅용 로그
                    isTestRunning = true;
                    chatBox.innerHTML = '';
                    statusDiv.textContent = '테스트 진행 중...';
                    testContent.style.display = 'block';
                    
                    // 감정 점수 초기화
                    emotionScores = {
                        '분노': 0,
                        '기쁨': 0,
                        '슬픔': 0,
                        '두려움': 0,
                        '놀람': 0
                    };
                    
                    // UI 업데이트
                    document.querySelectorAll('.progress-fill').forEach(el => {
                        el.style.width = '0%';
                    });
                    
                    document.querySelectorAll('[id^="emotion-"]').forEach(el => {
                        if (el.id.includes('-bar')) return;
                        el.textContent = '0%';
                    });
                    
                    document.getElementById('current-emotion').textContent = '현재 감정: -';
                    
                    // 첫 번째 메시지 전송
                    sendNextMessage();
                    
                } catch (error) {
                    console.error('테스트 시작 중 오류 발생:', error);
                    alert('테스트를 시작하는 중 오류가 발생했습니다: ' + error.message);
                    statusDiv.textContent = '오류 발생: ' + error.message;
                    isTestRunning = false;
                }
            }

            // 테스트 종료
            async function endTest() {
                isTestRunning = false;
                statusDiv.textContent = '테스트가 완료되었습니다.';
                
                try {
                    // 테스트 결과 저장 (필요한 경우)
                    // await fetch('/api/test/save', {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify({
                    //         scenarioId: currentScenario?.id,
                    //         messages: currentMessages,
                    //         emotionScores
                    //     })
                    // });
                } catch (error) {
                    console.error('테스트 결과 저장 중 오류 발생:', error);
                }
            }

            // 이벤트 리스너 등록
            startBtn.addEventListener('click', startTest);
            endBtn.addEventListener('click', endTest);

            // 초기화
            loadScenarios();
        });
    </script>
</body>
</html>
