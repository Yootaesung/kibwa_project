<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>감정 인식 챗봇</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>감정 인식 챗봇</h1>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- 채팅 메시지가 여기에 추가됩니다 -->
        </div>
        <div class="suggested-messages" id="suggested-messages">
            <!-- 추천 메시지가 여기에 표시됩니다 -->
        </div>
        <div class="chat-input">
            <input type="text" id="user-input" placeholder="메시지를 입력하세요..." autocomplete="off">
            <button id="send-btn">전송</button>
            <button id="end-btn">대화 종료</button>
            <button id="start-btn" style="display: none;">대화 시작</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const endBtn = document.getElementById('end-btn');
        const startBtn = document.getElementById('start-btn');
        const suggestedMessages = document.getElementById('suggested-messages');

        let chatData = {};
        let isConversationActive = true;

        function init() {
            checkAuthentication();
            
            fetch('/api/chat-data')
                .then(response => response.json())
                .then(data => {
                    chatData = data;
                })
                .catch(error => console.error('챗봇 데이터를 불러오는 중 오류가 발생했습니다:', error));

            userInput.addEventListener('keypress', handleKeyPress);
            sendBtn.addEventListener('click', handleSendClick);
            endBtn.addEventListener('click', handleEndClick);
            startBtn.addEventListener('click', startNewConversation);
            window.onload = () => userInput.focus();
        }

        async function checkAuthentication() {
            try {
                const response = await fetch('/api/check-auth');
                if (!response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('인증 체크 중 오류 발생:', error);
                window.location.href = '/login';
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && isConversationActive) {
                sendMessage();
            }
        }

        function handleSendClick() {
            if (isConversationActive) {
                sendMessage();
            }
        }

        function handleEndClick() {
            endConversation();
        }



        function filterProfanity(text) {
            const profanityMap = {
                '시발': 'XX', '새끼': 'XX', '미친': 'XXX', '병신': 'XX', '지랄': 'XX',
                '개새': 'XX', '닥쳐': 'XX', 'ㅅㅂ': 'XX', 'ㅂㅅ': 'XX', 'ㅈㄹ': 'XX', 'ㅁㅊ': 'XX'
            };
            
            let filteredText = text;
            for (const [word, replacement] of Object.entries(profanityMap)) {
                const regex = new RegExp(word, 'gi');
                filteredText = filteredText.replace(regex, replacement);
            }
            return filteredText;
        }

        function addMessage(text, isUser, messageId = null, isCenter = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'} ${isCenter ? 'center-message' : ''}`;
            if (messageId) {
                messageDiv.id = messageId;
            }
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const originalMessage = userInput.value.trim();
            if (originalMessage === '') return;

            const filteredMessage = filterProfanity(originalMessage);
            const isFiltered = originalMessage !== filteredMessage;

            const messageId = 'msg-' + Date.now();
            addMessage('...', true, messageId);
            userInput.value = '';

            $.ajax({
                url: '/chat/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    message: filteredMessage,
                    action: 'send',
                    is_filtered: true
                }),
                success: function(response) {
                    const messageElement = document.getElementById(messageId);
                    if (messageElement) {
                        if (isFiltered) {
                            messageElement.textContent = filteredMessage;
                            messageElement.title = '필터링된 메시지';
                            messageElement.classList.add('filtered-message');
                        } else {
                            messageElement.textContent = originalMessage;
                        }
                    }

                    if (response && response.response) {
                        const loadingId = 'loading-' + Date.now();
                        addMessage('...', false, loadingId);
                        
                        // Remove loading message and add actual response
                        setTimeout(() => {
                            const loadingElement = document.getElementById(loadingId);
                            if (loadingElement) {
                                loadingElement.remove();
                            }
                            addMessage(response.response, false);
                        }, 500);
                    } else {
                        console.error('Invalid response format:', response);
                        addMessage('응답을 처리하는 중 오류가 발생했습니다.', false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', status, error);
                    console.error('Response:', xhr.responseText);
                    const messageElement = document.getElementById(messageId);
                    if (messageElement) {
                        messageElement.textContent = '오류가 발생했습니다.';
                    }
                    let errorMsg = '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse.details) {
                            errorMsg += '\n' + errorResponse.details;
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    addMessage(errorMsg, false);
                }
            });
        }

        async function endConversation() {
            if (!isConversationActive) return;

            try {
                // 현재 채팅 메시지 수집
                const messages = [];
                const messageElements = document.querySelectorAll('.message:not(.centered)');
                
                messageElements.forEach(msgElement => {
                    const isUser = msgElement.classList.contains('user-message');
                    const role = isUser ? 'user' : 'assistant';
                    const content = msgElement.textContent.trim();
                    
                    if (content) {
                        messages.push({
                            role: role,
                            content: content
                        });
                    }
                });

                // 채팅 기록 저장 요청
                const response = await fetch('/api/end-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: messages
                    }),
                    credentials: 'include'  // 쿠키를 포함하기 위해 필요
                });

                if (!response.ok) {
                    throw new Error('채팅 기록 저장 실패');
                }

                // 기존 대화 종료 로직
                isConversationActive = false;
                addMessage('대화가 종료되었습니다.', false, null, true);
                endBtn.style.display = 'none';
                startBtn.style.display = 'inline-block';
                userInput.disabled = true;
                sendBtn.disabled = true;
                
            } catch (error) {
                console.error('Error:', error);
                addMessage('대화 종료 중 오류가 발생했습니다: ' + error.message, false);
            }
        }

        function startNewConversation() {
            chatMessages.innerHTML = '';
            isConversationActive = true;
            endBtn.style.display = 'inline-block';
            startBtn.style.display = 'none';
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        // 초기화 실행
        init();
    </script>
</body>
</html>
