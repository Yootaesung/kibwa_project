<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°ì • ì¸ì‹ ì±—ë´‡</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            width: 80%;
            max-width: 1000px;
            min-width: 900px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            background: #f5f7fa;
        }
        
        .chat-header {
            background-color: #4a6cfa;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: center;
            position: relative;
        }
        
        .home-btn {
            position: absolute;
            left: 20px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .home-btn i {
            margin-right: 5px;
        }
        
        .test-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            gap: 20px;
            margin: 20px auto 0;
            min-height: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
            max-width: 1000px;
            box-sizing: border-box;
        }
        
        .chat-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        
        .chat-input button {
            margin-left: 10px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #4a6cfa;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5ce4;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .emotion-panel {
            flex: 0 0 220px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .current-emotion {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            color: #4a6cfa;
        }
        
        .emotion-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .emotion-details h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }
        
        #emotion-scores {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .emotion-score {
            margin-bottom: 10px;
        }
        
        .emotion-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .emotion-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .emotion-progress {
            height: 100%;
            background-color: #4a6cfa;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-content">
                <a href="/login" class="home-btn">
                    <i class="material-icons">home</i> í™ˆ
                </a>
                <h1>ê°ì • ì¸ì‹ ì±—ë´‡</h1>
            </div>
        </div>
        <div class="test-container">
            <div class="content-wrapper">
                <div class="chat-box">
                    <div class="chat-messages" id="chat-messages">
                        <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                        <button id="send-btn" class="btn btn-primary">ì „ì†¡</button>
                        <button id="end-btn" class="btn btn-secondary">ëŒ€í™” ì¢…ë£Œ</button>
                        <button id="start-btn" class="btn btn-primary" style="display: none;">ëŒ€í™” ì‹œì‘</button>
                    </div>
                </div>
                <div class="emotion-panel">
                    <h3>í˜„ì¬ ê°ì •</h3>
                    <div id="current-emotion" class="current-emotion">-</div>
                    <!--
                    <div class="emotion-details">
                        <h4>ê°ì • ë¶„ì„ ê²°ê³¼</h4>
                        <div id="emotion-scores">
                            ê°ì • ì ìˆ˜ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                        </div>
                    </div>
                    -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const endBtn = document.getElementById('end-btn');
        const startBtn = document.getElementById('start-btn');
        const currentEmotionElement = document.getElementById('current-emotion');
        const emotionScoresElement = document.getElementById('emotion-scores');

        let chatData = {};
        let emotionKeywords = {};
        let isConversationActive = true;
        let currentEmotion = '-';
        let emotionScores = {
            'ê¸°ì¨': 0,
            'ìŠ¬í””': 0,
            'ë¶„ë…¸': 0,
            'ë¶ˆì•ˆ': 0,
            'ì¤‘ë¦½': 0,
            'ë†€ë¼ì›€': 0,
            'í˜ì˜¤': 0,
            'ê¸°ëŒ€': 0,
            'ê°ì‚¬': 0,
            'ì§€ë£¨í•¨': 0,
            'í”¼ë¡œ': 0
        };
        
        // ê°ì •ë³„ ìƒ‰ìƒ ë° ì´ëª¨í‹°ì½˜
        const emotionColors = {
            'ê¸°ì¨': '#FFD700',
            'ìŠ¬í””': '#5D8AA8',
            'ë¶„ë…¸': '#FF4B4B',
            'ë¶ˆì•ˆ': '#FFA500',
            'ì¤‘ë¦½': '#808080',
            'ë†€ë¼ì›€': '#9B59B6',
            'í˜ì˜¤': '#8E44AD',
            'ê¸°ëŒ€': '#3498DB',
            'ê°ì‚¬': '#2ECC71',
            'ì§€ë£¨í•¨': '#95A5A6',
            'í”¼ë¡œ': '#7F8C8D'
        };
        
        const emotionIcons = {
            'ê¸°ì¨': 'ğŸ˜Š',
            'ìŠ¬í””': 'ğŸ˜¢',
            'ë¶„ë…¸': 'ğŸ˜ ',
            'ë¶ˆì•ˆ': 'ğŸ˜¨',
            'ì¤‘ë¦½': 'ğŸ˜',
            'ë†€ë¼ì›€': 'ğŸ˜²',
            'í˜ì˜¤': 'ğŸ¤¢',
            'ê¸°ëŒ€': 'ğŸ¤©',
            'ê°ì‚¬': 'ğŸ™',
            'ì§€ë£¨í•¨': 'ğŸ˜‘',
            'í”¼ë¡œ': 'ğŸ˜´'
        };
        
        // ê°ì • í‚¤ì›Œë“œ ë¡œë“œ
        async function loadEmotionKeywords() {
            try {
                const response = await fetch('/emotion_data/emotion_keywords.json');
                if (!response.ok) {
                    throw new Error('ê°ì • í‚¤ì›Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                const data = await response.json();
                emotionKeywords = data.emotions;
                console.log('ë¡œë“œëœ ê°ì • í‚¤ì›Œë“œ:', emotionKeywords);
            } catch (error) {
                console.error('ê°ì • í‚¤ì›Œë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                // ê¸°ë³¸ í‚¤ì›Œë“œ ì„¤ì •
                emotionKeywords = {
                    'ê¸°ì¨': { 'keywords': ['í–‰ë³µ', 'ê¸°ì˜', 'ì¦ê±°', 'ì‹ ë‚˜', 'ì¢‹ì•„', 'ì‚¬ë‘', 'ì›ƒìŒ'] },
                    'ìŠ¬í””': { 'keywords': ['ìŠ¬í”„', 'ìš°ìš¸', 'ëˆˆë¬¼', 'ì•„ì‰½', 'ì†ìƒ'] },
                    'ë¶„ë…¸': { 'keywords': ['í™”ë‚˜', 'ì§œì¦', 'ì„±ì§ˆ', 'ì—´ë°›', 'í™”ë‚´'] },
                    'ë¶ˆì•ˆ': { 'keywords': ['ê±±ì •', 'ë¶ˆì•ˆ', 'ë‘ë ¤ì›€', 'ë¬´ì„œì›€', 'ë¶ˆì•ˆì •'] },
                    'ì¤‘ë¦½': { 'keywords': [] },
                    'ë†€ë¼ì›€': { 'keywords': ['ë†€ë¼ì›€', 'ê¹œì§', 'ëŒ€ë‹¨'] },
                    'í˜ì˜¤': { 'keywords': ['ì—­ê²¨ì›€', 'ì§•ê·¸ëŸ¬ì›€', 'êµ¬ì—­ì§ˆ'] },
                    'ê¸°ëŒ€': { 'keywords': ['ê¸°ëŒ€', 'ì„¤ë ˜', 'ê¸°ë‹¤ë¦¼'] },
                    'ê°ì‚¬': { 'keywords': ['ê°ì‚¬', 'ê³ ë§ˆì›€'] },
                    'ì§€ë£¨í•¨': { 'keywords': ['ì§€ë£¨í•¨', 'ì‹¬ì‹¬í•¨', 'ë”°ë¶„í•¨'] },
                    'í”¼ë¡œ': { 'keywords': ['í”¼ê³¤í•¨', 'ì§€ì¹¨', 'í˜ë“¦'] }
                };
                console.log('ê¸°ë³¸ ê°ì • í‚¤ì›Œë“œ ì‚¬ìš©:', emotionKeywords);
            }
        }

        async function init() {
            checkAuthentication();
            
            try {
                // ê°ì • í‚¤ì›Œë“œ ë¡œë“œ
                await loadEmotionKeywords();
                
                // ì±—ë´‡ ë°ì´í„° ë¡œë“œ
                const response = await fetch('/api/chat-data');
                if (response.ok) {
                    chatData = await response.json();
                }
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                userInput.addEventListener('keypress', handleKeyPress);
                sendBtn.addEventListener('click', handleSendClick);
                endBtn.addEventListener('click', handleEndClick);
                startBtn.addEventListener('click', startNewConversation);
                
                // ì´ˆê¸° í¬ì»¤ìŠ¤ ì„¤ì •
                userInput.focus();
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        }

        async function checkAuthentication() {
            try {
                const response = await fetch('/api/check-auth');
                if (!response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('ì¸ì¦ ì²´í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                window.location.href = '/login';
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && isConversationActive) {
                sendMessage();
            }
        }

        function handleSendClick() {
            if (isConversationActive) {
                sendMessage();
            }
        }

        function handleEndClick() {
            endConversation();
        }



        function filterProfanity(text) {
            const profanityMap = {
                'ì‹œë°œ': 'XX', 'ìƒˆë¼': 'XX', 'ë¯¸ì¹œ': 'XXX', 'ë³‘ì‹ ': 'XX', 'ì§€ë„': 'XX',
                'ê°œìƒˆ': 'XX', 'ë‹¥ì³': 'XX', 'ã……ã…‚': 'XX', 'ã…‚ã……': 'XX', 'ã…ˆã„¹': 'XX', 'ã…ã…Š': 'XX'
            };
            
            let filteredText = text;
            for (const [word, replacement] of Object.entries(profanityMap)) {
                const regex = new RegExp(word, 'gi');
                filteredText = filteredText.replace(regex, replacement);
            }
            return filteredText;
        }

        function addMessage(text, isUser, messageId = null, isCenter = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'} ${isCenter ? 'center-message' : ''}`;
            if (messageId) {
                messageDiv.id = messageId;
            }
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ê°ì • ë¶„ì„ í•¨ìˆ˜
        function analyzeEmotion(text) {
            // ëª¨ë“  ê°ì • ì ìˆ˜ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ê°ì • í¬í•¨)
            const scores = {
                'ê¸°ì¨': 0,
                'ìŠ¬í””': 0,
                'ë¶„ë…¸': 0,
                'ë¶ˆì•ˆ': 0,
                'ì¤‘ë¦½': 0,
                'ë†€ë¼ì›€': 0,
                'í˜ì˜¤': 0,
                'ê¸°ëŒ€': 0,
                'ê°ì‚¬': 0,
                'ì§€ë£¨í•¨': 0,
                'í”¼ë¡œ': 0
            };
            
            // ê° ê°ì •ë³„ë¡œ í‚¤ì›Œë“œ ë§¤ì¹­
            Object.entries(emotionKeywords).forEach(([emotion, data]) => {
                if (emotion === 'profanity') return; // ìš•ì„¤ í‚¤ì›Œë“œëŠ” ì œì™¸
                
                try {
                    // dataê°€ ê°ì²´ì´ê³  keywords ì†ì„±ì´ ìˆëŠ”ì§€ í™•ì¸
                    if (data && typeof data === 'object' && data.keywords) {
                        const keywords = Array.isArray(data.keywords) ? data.keywords : [];
                        
                        keywords.forEach(keyword => {
                            if (typeof keyword === 'string' && text.includes(keyword)) {
                                scores[emotion] = (scores[emotion] || 0) + 1;
                                console.log(`ì¼ì¹˜í•˜ëŠ” í‚¤ì›Œë“œ ë°œê²¬: ${emotion} - ${keyword}`);
                            }
                        });
                    }
                } catch (e) {
                    console.error(`ê°ì • í‚¤ì›Œë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ (${emotion}):`, e);
                }
            });
            
            // ë””ë²„ê¹…ì„ ìœ„í•´ ì ìˆ˜ ì¶œë ¥
            console.log('ê°ì • ì ìˆ˜:', scores);
            
            // ìš•ì„¤ ê°ì§€ (ë¶„ë…¸ ì ìˆ˜ ì¦ê°€)
            if (emotionKeywords.profanity && Array.isArray(emotionKeywords.profanity.keywords)) {
                const profanityPattern = new RegExp(emotionKeywords.profanity.keywords.join('|'), 'gi');
                if (profanityPattern.test(text)) {
                    scores['ë¶„ë…¸'] += 2; // ìš•ì„¤ì€ ë¶„ë…¸ ì ìˆ˜ ì¦ê°€
                }
            }
            
            // ë¬¸ì¥ ë¶€í˜¸ì™€ ê°íƒ„ì‚¬ì— ë”°ë¥¸ ì ìˆ˜ ì¡°ì •
            const exclamationCount = (text.match(/!/g) || []).length;
            const questionCount = (text.match(/\?/g) || []).length;
            
            if (exclamationCount > 0) {
                // ëŠë‚Œí‘œê°€ ìˆìœ¼ë©´ ê¸ì •, ë†€ë¼ì›€, ë¶„ë…¸ ê°ì • ì¦ê°€
                const positiveWords = ['ì¢‹ì•„', 'í–‰ë³µ', 'ì‚¬ë‘', 'ê¸°ë»', 'ëŒ€ë‹¨', 'ê°ì‚¬'];
                const surpriseWords = ['ë†€ë', 'ê¹œì§', 'ëŒ€ë‹¨', 'ë†€ë¼ìš´', 'ë†€ë¼ì›Œ'];
                
                const hasPositiveWord = positiveWords.some(word => text.includes(word));
                const hasSurpriseWord = surpriseWords.some(word => text.includes(word));
                
                if (hasPositiveWord) {
                    scores['ê¸°ì¨'] += exclamationCount * 0.5;
                } else if (hasSurpriseWord) {
                    scores['ë†€ë¼ì›€'] += exclamationCount * 0.7;
                } else {
                    scores['ë¶„ë…¸'] += exclamationCount * 0.3;
                }
            }
            
            if (questionCount > 0) {
                // ë¬¼ìŒí‘œê°€ ìˆìœ¼ë©´ ë¶ˆì•ˆ ê°ì • ì¦ê°€
                scores['ë¶ˆì•ˆ'] += questionCount * 0.3;
            }
            
            // ì ìˆ˜ ì •ê·œí™” (í•©ì´ 1ì´ ë˜ë„ë¡)
            const total = Object.values(scores).reduce((a, b) => a + b, 0);
            
            if (total === 0) {
                // í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ì¤‘ë¦½
                scores['ì¤‘ë¦½'] = 1;
            } else {
                // ì ìˆ˜ ì •ê·œí™”
                Object.keys(scores).forEach(key => {
                    scores[key] = scores[key] / total;
                });
            }
            
            return scores;
        }
        
        // ê°ì • ì ìˆ˜ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
        function updateEmotionScores(newScores, showEmotion = false) {
            // ìƒˆë¡œìš´ ê°ì • ì ìˆ˜ë¡œ ë°”ë¡œ ì—…ë°ì´íŠ¸ (ê°€ì¤‘ í‰ê·  ì œê±°)
            Object.assign(emotionScores, newScores);
            
            // í˜„ì¬ ê°ì • ê²°ì • (ê°€ì¥ ë†’ì€ ì ìˆ˜)
            let maxScore = -1;
            let dominantEmotion = 'ì¤‘ë¦½';
            
            // ì¤‘ë¦½ì„ ì œì™¸í•œ ê°ì • ì¤‘ ê°€ì¥ ë†’ì€ ì ìˆ˜ ì°¾ê¸°
            Object.entries(emotionScores).forEach(([emotion, score]) => {
                if (emotion !== 'ì¤‘ë¦½' && score > maxScore) {
                    maxScore = score;
                    dominantEmotion = emotion;
                }
            });
            
            // ëª¨ë“  ì ìˆ˜ê°€ 0ì´ë©´ ì¤‘ë¦½ìœ¼ë¡œ ì„¤ì •
            if (maxScore <= 0) {
                dominantEmotion = 'ì¤‘ë¦½';
            }
            
            currentEmotion = dominantEmotion;
            
            // UI ì—…ë°ì´íŠ¸: ë©”ì‹œì§€ í‘œì‹œ ì‹œì—ë§Œ ê°ì • í‘œì‹œ, ê·¸ ì™¸ëŠ” ... í‘œì‹œ
            if (showEmotion) {
                currentEmotionElement.textContent = `${emotionIcons[dominantEmotion]} ${dominantEmotion}`;
                currentEmotionElement.style.backgroundColor = `${emotionColors[dominantEmotion]}20`; // 20% íˆ¬ëª…ë„
                currentEmotionElement.style.color = emotionColors[dominantEmotion];
            } else {
                currentEmotionElement.textContent = '...';
                currentEmotionElement.style.backgroundColor = '#f8f9fa';
                currentEmotionElement.style.color = '#4a6cfa';
            }
            
            // ê°ì • ì ìˆ˜ ë°” ì—…ë°ì´íŠ¸ (ì£¼ì„ ì²˜ë¦¬ë¨)
            // updateEmotionBars();
        }
        
        // ê°ì • ì ìˆ˜ ë°” ì—…ë°ì´íŠ¸
        function updateEmotionBars() {
            emotionScoresElement.innerHTML = '';
            
            // ì¤‘ë¦½ì„ ì œì™¸í•œ ê°ì •ë“¤ë§Œ í•„í„°ë§í•˜ê³  ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
            const emotions = Object.entries(emotionScores)
                .filter(([emotion]) => emotion !== 'ì¤‘ë¦½')
                .sort((a, b) => b[1] - a[1]);
            
            // ì¤‘ë¦½ì„ ì œì™¸í•œ ê°ì •ë“¤ í‘œì‹œ
            emotions.forEach(([emotion, score]) => {
                createEmotionBar(emotion, score);
            });
            
            // ì¤‘ë¦½ì€ í•­ìƒ ë§ˆì§€ë§‰ì— í‘œì‹œ
            if ('ì¤‘ë¦½' in emotionScores) {
                createEmotionBar('ì¤‘ë¦½', emotionScores['ì¤‘ë¦½']);
            }
            
            // ê°ì • ë°” ìƒì„± í•¨ìˆ˜
            function createEmotionBar(emotion, score) {
                const scoreElement = document.createElement('div');
                scoreElement.className = 'emotion-score';
                
                const labelElement = document.createElement('div');
                labelElement.className = 'emotion-label';
                labelElement.innerHTML = `
                    <span>${emotionIcons[emotion]} ${emotion}</span>
                    <span>${Math.round(score * 100)}%</span>
                `;
                
                const barElement = document.createElement('div');
                barElement.className = 'emotion-bar';
                
                const progressElement = document.createElement('div');
                progressElement.className = 'emotion-progress';
                progressElement.style.width = `${score * 100}%`;
                progressElement.style.backgroundColor = emotionColors[emotion];
                
                barElement.appendChild(progressElement);
                scoreElement.appendChild(labelElement);
                scoreElement.appendChild(barElement);
                emotionScoresElement.appendChild(scoreElement);
            }
        }
        
        // ì´ˆê¸° ê°ì • ë°” í‘œì‹œ (ì£¼ì„ ì²˜ë¦¬ë¨)
        // updateEmotionBars();

        function sendMessage() {
            const originalMessage = userInput.value.trim();
            if (originalMessage === '') return;

            const filteredMessage = filterProfanity(originalMessage);
            const isFiltered = originalMessage !== filteredMessage;

            const messageId = 'msg-' + Date.now();
            addMessage('...', true, messageId);
            userInput.value = '';
            
            // ë©”ì‹œì§€ ì „ì†¡ ì‹œ ê°ì • í‘œì‹œ ë¹„í™œì„±í™”
            updateEmotionScores({}, false);
            
            // ë©”ì‹œì§€ ì „ì†¡ í›„ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            userInput.focus();

            $.ajax({
                url: '/chat/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    message: filteredMessage,
                    action: 'send',
                    is_filtered: true
                }),
                success: function(response) {
                    const messageElement = document.getElementById(messageId);
                    if (messageElement) {
                        if (isFiltered) {
                            messageElement.textContent = filteredMessage;
                            messageElement.title = 'í•„í„°ë§ëœ ë©”ì‹œì§€';
                            messageElement.classList.add('filtered-message');
                        } else {
                            messageElement.textContent = originalMessage;
                        }
                        
                        // ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ ì‹œ ê°ì • í‘œì‹œ í™œì„±í™”
                        const emotionScores = analyzeEmotion(originalMessage);
                        updateEmotionScores(emotionScores, true);
                    }

                    if (response && response.response) {
                        const loadingId = 'loading-' + Date.now();
                        addMessage('...', false, loadingId);
                        
                        // Remove loading message and add actual response
                        setTimeout(() => {
                            const loadingElement = document.getElementById(loadingId);
                            if (loadingElement) {
                                loadingElement.remove();
                            }
                            addMessage(response.response, false);
                            
                            // ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ ì‹œ ê°ì • í‘œì‹œ ë¹„í™œì„±í™”
                            updateEmotionScores({}, false);
                        }, 500);
                    } else {
                        console.error('Invalid response format:', response);
                        addMessage('ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', status, error);
                    console.error('Response:', xhr.responseText);
                    const messageElement = document.getElementById(messageId);
                    if (messageElement) {
                        messageElement.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    }
                    let errorMsg = 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse.details) {
                            errorMsg += '\n' + errorResponse.details;
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    addMessage(errorMsg, false);
                }
            });
            
            // ê°ì • ë¶„ì„ ìˆ˜í–‰
            const emotionScores = analyzeEmotion(originalMessage);
            updateEmotionScores(emotionScores);
        }

        async function endConversation() {
            if (!isConversationActive) return;

            try {
                // í˜„ì¬ ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì§‘
                const messages = [];
                const messageElements = document.querySelectorAll('.message:not(.centered)');
                
                messageElements.forEach(msgElement => {
                    const isUser = msgElement.classList.contains('user-message');
                    const role = isUser ? 'user' : 'assistant';
                    const content = msgElement.textContent.trim();
                    
                    if (content) {
                        messages.push({
                            role: role,
                            content: content
                        });
                    }
                });

                // ì±„íŒ… ê¸°ë¡ ì €ì¥ ìš”ì²­
                const response = await fetch('/api/end-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: messages
                    }),
                    credentials: 'include'  // ì¿ í‚¤ë¥¼ í¬í•¨í•˜ê¸° ìœ„í•´ í•„ìš”
                });

                if (!response.ok) {
                    throw new Error('ì±„íŒ… ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨');
                }

                // ê¸°ì¡´ ëŒ€í™” ì¢…ë£Œ ë¡œì§
                isConversationActive = false;
                addMessage('ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', false, null, true);
                endBtn.style.display = 'none';
                startBtn.style.display = 'inline-block';
                userInput.disabled = true;
                sendBtn.disabled = true;
                
            } catch (error) {
                console.error('Error:', error);
                addMessage('ëŒ€í™” ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, false);
            }
        }

        function startNewConversation() {
            chatMessages.innerHTML = '';
            isConversationActive = true;
            endBtn.style.display = 'inline-block';
            startBtn.style.display = 'none';
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
            
            // ê°ì • ì ìˆ˜ ì´ˆê¸°í™”
            Object.keys(emotionScores).forEach(key => {
                emotionScores[key] = 0;
            });
            emotionScores['ì¤‘ë¦½'] = 1;
            updateEmotionBars();
            
            // í˜„ì¬ ê°ì • ì´ˆê¸°í™”
            currentEmotionElement.textContent = '-';
            currentEmotionElement.style.backgroundColor = '';
            currentEmotionElement.style.color = '';
            
            // í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
            addMessage('ì•ˆë…•í•˜ì„¸ìš”! ê°ì •ì„ ë¶„ì„í•´ ë“œë¦¬ëŠ” ì±—ë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì´ë“  ë§ì”€í•´ì£¼ì„¸ìš”.', false, null, true);
        }

        // ì´ˆê¸°í™” ì‹¤í–‰
        init();
    </script>
</body>
</html>
